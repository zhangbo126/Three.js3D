"use strict";(self["webpackChunkprodect"]=self["webpackChunkprodect"]||[]).push([[614],{2614:function(e,t,i){var s=i(3396),n=(i(560),i(9242)),o=i(1114),a=i(2748),r=i(7178),l=i(1015),h=i(4543),d=i(9469),c=i(8421),m=i(2338),p=i(840),u=i(5070),g=i(9066),w=i(328),f=i(9868),C=i(499),L=i(6573),M=i(2519),b=i(872),S=i(1794),x=i(2346);function v(e){return"function"===typeof e||"[object Object]"===Object.prototype.toString.call(e)&&!(0,s.lA)(e)}class P{constructor(e,t){this.config=e,this.container=document.querySelector("#"+t),this.camera,this.scene,this.renderer,this.controls,this.model,this.fileLoaderMap={glb:new d.E,fbx:new L.y,gltf:new d.E,obj:new C.L},this.modelAnimation,this.animationMixer,this.animationColock=new o.Clock,this.animationFrame,this.rotationAnimationFrame,this.animateClipAction=null,this.loopMap={LoopOnce:o.LoopOnce,LoopRepeat:o.LoopRepeat,LoopPingPong:o.LoopPingPong},this.skeletonHelper,this.gridHelper,this.axesHelper,this.planeGeometry,this.modelMaterialList,this.effectComposer,this.outlinePass,this.renderAnimation,this.raycaster=new o.Raycaster,this.mouse=new o.Vector2,this.modelTextureMap,this.glowComposer,this.unrealBloomPass,this.shaderPass,this.glowMaterialList,this.materials={},this.onWindowResizesListener,this.onMouseMoveListener,this.css3dControls=null,this.css3DRenderer=null}init(){return new Promise((async(e,t)=>{this.initRender(),this.initCamera(),this.initScene(),this.initControls();const i=await this.loadModel(this.config.fileInfo);this.createEffectComposer(),this.setSceneBackground(),this.setModelMeaterial(),this.setModelLaterStage(),this.setSceneLight(),this.setModelAnimation(),this.setModelAxleLine(),this.setSceneTagsRender(),this.sceneAnimation(),this.addEvenListMouseLisatener(),e(i)}))}initRender(){this.renderer=new o.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio);const{clientHeight:e,clientWidth:t}=this.container;this.renderer.setSize(t,e),this.renderer.toneMapping=o.ReinhardToneMapping,this.renderer.autoClear=!0,this.renderer.outputColorSpace=o.SRGBColorSpace,this.renderer.toneMappingExposure=2,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=o.PCFSoftShadowMap,this.container.appendChild(this.renderer.domElement),this.css3DRenderer=new M.lX,this.css3DRenderer.setSize(t,e),this.css3DRenderer.domElement.style.position="absolute",this.css3DRenderer.domElement.style.pointerEvents="none",this.css3DRenderer.domElement.style.top=0}initCamera(){const{clientHeight:e,clientWidth:t}=this.container;this.camera=new o.PerspectiveCamera(45,t/e,.25,2e3);const{camera:i}=this.config;if(!i)return!1;const{x:s,y:n,z:a}=i;this.camera.position.set(s,n,a),this.camera.updateProjectionMatrix()}initScene(){this.scene=new o.Scene}addEvenListMouseLisatener(){this.onWindowResizesListener=this.onWindowResize.bind(this),window.addEventListener("resize",this.onWindowResizesListener)}initControls(){this.controls=new h.z(this.camera,this.renderer.domElement),this.controls.enablePan=!0,this.controls.enabled=!0,this.css3dControls=new h.z(this.camera,this.css3DRenderer.domElement),this.css3dControls.enablePan=!1,this.css3dControls.enableDamping=!0,this.css3dControls.target.set(0,0,0),this.css3dControls.update()}sceneAnimation(){this.renderAnimation=requestAnimationFrame((()=>this.sceneAnimation()));const{stage:e,tags:t}=this.config;e&&e.glow?this.setMeshFlow():(this.effectComposer.render(),this.controls.update()),t&&t.dragTagList.length&&(this.css3DRenderer.render(this.scene,this.camera),this.css3dControls.update())}setMeshFlow(){this.scene.traverse((e=>{e instanceof o.GridHelper&&(this.materials.gridHelper=e.material,e.material=new o.MeshStandardMaterial({color:"#000"})),e instanceof o.Scene&&(this.materials.scene=e.background,this.materials.environment=e.environment,e.background=null,e.environment=null),!this.glowMaterialList.includes(e.name)&&e.isMesh&&(this.materials[e.uuid]=e.material,e.material=new o.MeshStandardMaterial({color:"#000"}))})),this.glowComposer.render(),this.scene.traverse((e=>{this.materials[e.uuid]&&(e.material=this.materials[e.uuid],delete this.materials[e.uuid]),e instanceof o.GridHelper&&(e.material=this.materials.gridHelper,delete this.materials.gridHelper),e instanceof o.Scene&&(e.background=this.materials.scene,e.environment=this.materials.environment,delete this.materials.scene,delete this.materials.environment)})),this.effectComposer.render(),this.controls.update()}createEffectComposer(){const{clientHeight:e,clientWidth:t}=this.container;this.effectComposer=new c.x(this.renderer);const i=new m.C(this.scene,this.camera);this.effectComposer.addPass(i),this.outlinePass=new p.f(new o.Vector2(t,e),this.scene,this.camera),this.outlinePass.visibleEdgeColor=new o.Color("#FF8C00"),this.outlinePass.hiddenEdgeColor=new o.Color("#8a90f3"),this.outlinePass.edgeGlow=2,this.outlinePass.edgeThickness=1,this.outlinePass.edgeStrength=4,this.outlinePass.pulsePeriod=100,this.effectComposer.addPass(this.outlinePass);let s=new u.v;this.effectComposer.addPass(s);let n=new g.T(w.C);const a=this.renderer.getPixelRatio();n.uniforms.resolution.value.set(1/(t*a),1/(e*a)),n.renderToScreen=!0,n.needsSwap=!0,this.effectComposer.addPass(n),this.unrealBloomPass=new f.m(new o.Vector2(t,e),0,0,0);const r={minFilter:o.LinearFilter,magFilter:o.LinearFilter,format:o.RGBAFormat,stencilBuffer:!1},l=new o.WebGLRenderTarget(2*t,2*e,r);this.glowComposer=new c.x(this.renderer,l),this.glowComposer.renderToScreen=!1,this.glowComposer.addPass(new m.C(this.scene,this.camera)),this.glowComposer.addPass(this.unrealBloomPass),this.shaderPass=new g.T(new o.ShaderMaterial({uniforms:{baseTexture:{value:null},bloomTexture:{value:this.glowComposer.renderTarget2.texture},tDiffuse:{value:null},glowColor:{value:null}},vertexShader:b.C7,fragmentShader:b.zH,defines:{}}),"baseTexture"),this.shaderPass.material.uniforms.glowColor.value=new o.Color,this.shaderPass.renderToScreen=!0,this.shaderPass.needsSwap=!0,this.effectComposer.addPass(this.shaderPass)}loadModel({filePath:e,fileType:t,map:i}){return new Promise(((s,n)=>{const a=this.fileLoaderMap[t];a.load(e,(e=>{switch(t){case"glb":this.model=e.scene,this.skeletonHelper=new o.SkeletonHelper(e.scene);break;case"fbx":this.model=e,this.skeletonHelper=new o.SkeletonHelper(e);break;case"gltf":this.model=e.scene,this.skeletonHelper=new o.SkeletonHelper(e.scene);break;case"obj":this.model=e,this.skeletonHelper=new o.SkeletonHelper(e);break;default:break}this.getModelMeaterialList(i),this.modelAnimation=e.animations||[],this.setModelPositionSize(),this.skeletonHelper.visible=!1,this.scene.add(this.skeletonHelper),this.glowMaterialList=this.modelMaterialList.map((e=>e.name)),this.scene.add(this.model),s(!0)}),(()=>{}),(e=>{r.z8.error("文件错误"),console.log(e),n()}))}))}onWindowResize(){const{clientHeight:e,clientWidth:t}=this.container;if(this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.css3DRenderer.setSize(t,e),this.effectComposer){var i=this.effectComposer.passes[3];const s=this.renderer.getPixelRatio();i.uniforms.resolution.value.set(1/(t*s),1/(e*s)),this.effectComposer.setSize(t,e)}this.glowComposer&&this.glowComposer.setSize(t,e)}onClearModelData(){cancelAnimationFrame(this.rotationAnimationFrame),cancelAnimationFrame(this.renderAnimation),cancelAnimationFrame(this.animationFrame);const{tags:e}=this.config;this.scene.traverse((e=>{"Mesh"===e.type&&(e.geometry.dispose(),e.material.dispose())})),this.scene.clear(),this.renderer.clear(),this.renderer.dispose(),this.camera.clear(),this.gridHelper&&(this.gridHelper.clear(),this.gridHelper.dispose()),this.axesHelper&&(this.axesHelper.clear(),this.axesHelper.dispose()),this.effectComposer.dispose(),this.glowComposer.dispose(),this.container.removeEventListener("mousemove",this.onMouseMoveListener),window.removeEventListener("resize",this.onWindowResizesListener),this.config=null,this.container=null,this.camera=null,this.scene=null,this.renderer=null,this.controls=null,this.model=null,this.fileLoaderMap=null,this.modelAnimation=null,this.animationMixer=null,this.animationColock=null,this.animationFrame=null,this.rotationAnimationFrame=null,this.animateClipAction=null,this.loopMap=null,this.skeletonHelper=null,this.gridHelper=null,this.axesHelper=null,this.planeGeometry=null,this.modelMaterialList=null,this.effectComposer=null,this.outlinePass=null,this.renderAnimation=null,this.raycaster,this.mouse=null,this.modelTextureMap=null,this.glowComposer=null,this.unrealBloomPass=null,this.shaderPass=null,this.glowMaterialList=null,this.materials=null,this.css3dControls=null,this.css3DRenderer=null}setModelPositionSize(){this.model.updateMatrixWorld();const e=(new o.Box3).setFromObject(this.model),t=e.getSize(new o.Vector3),i=e.getCenter(new o.Vector3),s=Math.max(t.x,t.y,t.z),n=2.5,a=n/(s>1?s:.5);this.model.scale.set(a,a,a),this.model.position.sub(i.multiplyScalar(a)),this.controls.maxDistance=10*t.length(),this.camera.updateProjectionMatrix()}getModelMeaterialList(){this.modelMaterialList=[],this.model.traverse((e=>{if(e.isMesh&&(e.castShadow=!0,e.frustumCulled=!1,e.material)){const t=e.material.clone();e.material=t,this.modelMaterialList.push(e)}}))}setSceneBackground(){const{background:e}=this.config;if(!e)return!1;if(e.visible){const{color:t,image:i,viewImg:s,intensity:n,blurriness:a}=e;switch(e.type){case 1:this.scene.background=new o.Color(t);break;case 2:const e=(new o.TextureLoader).load(i);this.scene.background=e,e.dispose();break;case 3:const r=(new o.TextureLoader).load(s);r.mapping=o.EquirectangularReflectionMapping,this.scene.background=r,this.scene.environment=r,this.scene.backgroundIntensity=n,this.scene.backgroundBlurriness=a,r.dispose();break;default:break}}else this.scene.background=new o.Color("#000")}setModelMeaterial(){const{material:e}=this.config;if(!e||!e.meshList)return!1;const t=S.or.map((e=>e.id));e.meshList.forEach((i=>{const s=this.model.getObjectByProperty("name",i.meshName),{color:n,opacity:a,depthWrite:r,wireframe:l,visible:h,type:d}=i,{map:c}=s.material;if(e.materialType?s.material=new o[d]({map:c}):s.material.map=c,i.meshFrom)if(t.includes(i.meshFrom)){const t=S.or.find((e=>e.id==i.meshFrom))||{},n=(new o.TextureLoader).load(t.url);n.wrapS=o.MirroredRepeatWrapping,n.wrapT=o.MirroredRepeatWrapping,n.flipY=!1,n.colorSpace=o.SRGBColorSpace,n.minFilter=o.LinearFilter,n.magFilter=o.LinearFilter,e.materialType?s.material=new o[d]({map:n}):s.material.map=n,n.dispose()}else{const t=this.model.getObjectByProperty("name",i.meshFrom),{map:n}=t.material;e.materialType?s.material=new o[d]({map:n}):s.material.map=n}s.material.visible=h,s.material.color.set(new o.Color(n)),s.material.wireframe=l,s.material.depthWrite=r,s.material.transparent=!0,s.material.opacity=a}))}setModelLaterStage(){const{stage:e}=this.config;if(!e)return!1;const{threshold:t,strength:i,radius:s,toneMappingExposure:n,meshPositonList:a,color:r}=e;e.glow?(this.unrealBloomPass.threshold=t,this.unrealBloomPass.strength=i,this.unrealBloomPass.radius=s,this.renderer.toneMappingExposure=n,this.shaderPass.material.uniforms.glowColor.value=new o.Color(r)):(this.unrealBloomPass.threshold=0,this.unrealBloomPass.strength=0,this.unrealBloomPass.radius=0,this.renderer.toneMappingExposure=n,this.shaderPass.material.uniforms.glowColor.value=new o.Color),a.forEach((e=>{const t=this.model.getObjectByProperty("name",e.name),{rotation:i,scale:s,position:n}=e;t.rotation.set(i.x,i.y,i.z),t.scale.set(s.x,s.y,s.z),t.position.set(n.x,n.y,n.z)}))}setSceneLight(){const{light:e}=this.config;if(!e)return!1;if(e.ambientLight){const t=new o.AmbientLight(e.ambientLightColor,e.ambientLightIntensity);t.visible=e.ambientLight,this.scene.add(t)}if(e.directionalLight){const t=new o.DirectionalLight(e.directionalLightColor,e.directionalLightIntensity),{x:i,y:s,z:n}=(0,x.E3)(e.directionalHorizontal,e.directionalVertical,e.directionalSistance);t.position.set(i,s,n),t.castShadow=e.directionaShadow,t.visible=e.directionalLight,this.scene.add(t);const a=new o.DirectionalLightHelper(t,.5);a.visible=e.directionalLightHelper,this.scene.add(a)}if(e.pointLight){const t=new o.PointLight(e.pointLightColor,e.pointLightIntensity,100);t.visible=e.pointLight;const{x:i,y:s,z:n}=(0,x.E3)(e.pointHorizontal,e.pointVertical,e.pointSistance);t.position.set(i,s,n),this.scene.add(t);const a=new o.PointLightHelper(t,.5);a.visible=e.pointLightHelper,this.scene.add(a)}if(e.spotLight){const t=new o.SpotLight(e.spotLightColor,900);t.visible=e.spotLight;const s=(new o.TextureLoader).load(i(8208));s.dispose(),t.map=s,t.decay=2,t.shadow.mapSize.width=1920,t.shadow.mapSize.height=1080,t.shadow.camera.near=1,t.shadow.camera.far=10,t.intensity=e.spotLightIntensity,t.angle=e.spotAngle,t.penumbra=e.spotPenumbra,t.shadow.focus=e.spotFocus,t.castShadow=e.spotCastShadow,t.distance=e.spotDistance;const{x:n,y:a,z:r}=(0,x.E3)(e.spotHorizontal,e.spotVertical,e.spotSistance);t.position.set(n,a,r),this.scene.add(t);const l=new o.SpotLightHelper(t);l.visible=e.spotLightHelper&&e.spotLight,this.scene.add(l)}if(e.planeGeometry){const i=new o.PlaneGeometry(e.planeWidth,e.planeHeight);var t=new o.MeshStandardMaterial({color:e.planeColor});const s=new o.Mesh(i,t);s.rotation.x=-Math.PI/2,s.position.set(0,-1.2,0),s.visible=e.planeGeometry,s.material.side=o.DoubleSide,s.geometry.verticesNeedUpdate=!0,s.receiveShadow=!0,this.scene.add(s)}}setModelAnimation(){const{animation:e}=this.config;if(!e)return!1;if(this.modelAnimation.length&&e&&e.visible){this.animationMixer=new o.AnimationMixer(this.model);const{animationName:t,timeScale:i,weight:s,loop:n}=e,a=o.AnimationClip.findByName(this.modelAnimation,t);a&&(this.animateClipAction=this.animationMixer.clipAction(a),this.animateClipAction.setEffectiveTimeScale(i),this.animateClipAction.setEffectiveWeight(s),this.animateClipAction.setLoop(this.loopMap[n]),this.animateClipAction.play()),this.animationFrameFun()}if(e.rotationVisible){const{rotationType:t,rotationSpeed:i}=e;this.rotationAnimationFun(t,i)}}animationFrameFun(){this.animationFrame=requestAnimationFrame((()=>this.animationFrameFun())),this.animationMixer&&this.animationMixer.update(this.animationColock.getDelta())}rotationAnimationFun(e,t){this.rotationAnimationFrame=requestAnimationFrame((()=>this.rotationAnimationFun(e,t))),this.model.rotation[e]+=t/50}setModelAxleLine(){const{attribute:e}=this.config;if(!e)return!1;const{axesHelper:t,axesSize:i,color:s,divisions:n,gridHelper:a,positionX:r,positionY:l,positionZ:h,size:d,skeletonHelper:c,visible:m,x:p,y:u,z:g,rotationX:w,rotationY:f,rotationZ:C}=e;if(!m)return!1;this.gridHelper=new o.GridHelper(d,n,s,s),this.gridHelper.position.set(p,u,g),this.gridHelper.visible=a,this.gridHelper.material.linewidth=.1,this.scene.add(this.gridHelper),this.axesHelper=new o.AxesHelper(i),this.axesHelper.visible=t,this.axesHelper.position.set(0,-.5,0),this.scene.add(this.axesHelper),this.model.position.set(r,l,h),this.model.rotation.set(w,f,C),this.renderer.shadowMap.enabled=!0,this.skeletonHelper.visible=c}setSceneTagsRender(){const{tags:e}=this.config;e&&e.dragTagList.length&&(this.container.appendChild(this.css3DRenderer.domElement),e.dragTagList.forEach((e=>{let t=document.createElement("div");const{backgroundColor:i,color:o,fontSize:r,height:h,iconColor:d,iconName:c,iconSize:m,innerText:p,positionX:u,positionY:g,positionZ:w,width:f}=e,C=(0,n.ri)({render(){let e;return(0,s.Wm)("div",null,[(0,s.Wm)("div",{className:"element-tag",style:{width:f+"px",height:h+"px",fontSize:r+"px",color:o,backgroundColor:i,boxShadow:`0px 0px 4px ${i}`}},[(0,s.Wm)("span",{className:"tag-txt"},[p])]),(0,s.Wm)("div",{className:"tag-icon"},[(0,s.Wm)(l.gn,null,v(e=(0,s.h)(a[c]))?e:{default:()=>[e]})])])}}),L=C.mount(document.createElement("div"));t.appendChild(L.$el);let b=new M.cp(t);b.position.set(u,g,w),b.scale.set(.01,.01,.01);const S=t.querySelector(".tag-icon");S.style.fontSize=m+"px",S.style.color=d,this.scene.add(b)})))}}function y(e){const t="answer"+(0,x.d1)(5,10);let i=null;return(0,s.aZ)({data(){return{loading:!1}},props:["width","height"],watch:{$props:{handler(e){i&&(0,x.Ds)(i.onWindowResize(),200)},immediate:!1,deep:!0}},render(){return this.width&&this.height?(0,s.h)((0,s.wy)((0,s.Wm)("div",{style:{width:this.width-10+"px",height:this.height-10+"px",pointerEvents:"none"},id:t},null),[[(0,s.Q2)("zLoading"),this.loading]])):(0,s.h)((0,s.wy)((0,s.Wm)("div",{style:{width:"100%",height:"100%"},id:t},null),[[(0,s.Q2)("zLoading"),this.loading]]))},async mounted(){this.loading=!0,i=new P(e,t);const s=await i.init();s&&(this.loading=!1)},beforeUnmount(){i.onClearModelData()}})}t.Z=y}}]);
import{T as q,L as R,i as D,h as T,l as u,E as X,I as Y,J as $,B as J,M as U}from"./main-2rZIAjPF.js";import{aj as Z,an as S,ao as _,ap as K,aq as Q,ar as ee,as as te,at as ie,au as se,a0 as ae,av as y,W as ne,aw as oe,h as k,ax as re,ay as le,i as he,j as A,az as B,ah as F,aB as w,aJ as W,aL as j,aM as de,C as p,aN as ce,aO as O,aP as me,aQ as pe,aK as ue,S as ge,aR as fe,aS as we,aA as Le,M as I,_ as Ce,V as G,T as L,X as Me,c as N,$ as z,F as V,L as C,aC as be,aD as xe,ae as H,aE as Pe,aF as Se,aG as ye,aH as Ae,g as Fe,aI as ze,f as He,D as Re,af as ve,ag as Ee,ai as De,ak as Te,aY as ke,p as Be}from"./CSS3DRenderer-ExBz_HNT.js";function We(g){return typeof g=="function"||Object.prototype.toString.call(g)==="[object Object]"&&!U(g)}class je{constructor(e,i){this.config=e,this.container=document.querySelector("#"+i),this.camera,this.scene,this.renderer,this.controls,this.model,this.fileLoaderMap={glb:new S,fbx:new _(this.loadingManager),gltf:new S,obj:new K(this.loadingManager),stl:new Q},this.modelAnimation,this.animationMixer,this.animationClock=new ee,this.animationFrame,this.rotationAnimationFrame,this.animateClipAction=null,this.loopMap={LoopOnce:te,LoopRepeat:ie,LoopPingPong:se},this.gridHelper,this.axesHelper,this.planeGeometry,this.modelMaterialList,this.effectComposer,this.outlinePass,this.renderAnimation,this.raycaster=new ae,this.mouse=new y,this.modelTextureMap,this.glowComposer,this.unrealBloomPass,this.shaderPass,this.glowMaterialList,this.materials={},this.onWindowResizesListener,this.onMouseMoveListener,this.css3dControls=null,this.css3DRenderer=null}init(){return new Promise(async(e,i)=>{this.initRender(),this.initCamera(),this.initScene(),this.initControls();const t=await this.loadModel(this.config.fileInfo);this.createEffectComposer(),this.setSceneBackground(),this.setModelMeaterial(),this.setModelLaterStage(),this.setSceneLight(),this.setModelAnimation(),this.setModelAxleLine(),this.setSceneTagsRender(),this.sceneAnimation(),this.addEvenListMouseListener(),e(t)})}initRender(){this.renderer=new ne({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio);const{clientHeight:e,clientWidth:i}=this.container;this.renderer.setSize(i,e),this.renderer.toneMapping=oe,this.renderer.autoClear=!0,this.renderer.outputColorSpace=k,this.renderer.toneMappingExposure=2,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=re,this.container.appendChild(this.renderer.domElement),this.css3DRenderer=new le,this.css3DRenderer.setSize(i,e),this.css3DRenderer.domElement.style.position="absolute",this.css3DRenderer.domElement.style.pointerEvents="none",this.css3DRenderer.domElement.style.top=0}initCamera(){const{clientHeight:e,clientWidth:i}=this.container;this.camera=new he(45,i/e,.25,2e3);const{camera:t}=this.config;if(!t)return!1;const{x:s,y:o,z:n}=t;this.camera.position.set(s,o,n),this.camera.updateProjectionMatrix()}initScene(){this.scene=new A}addEvenListMouseListener(){this.onWindowResizesListener=this.onWindowResize.bind(this),window.addEventListener("resize",this.onWindowResizesListener)}initControls(){this.controls=new B(this.camera,this.renderer.domElement),this.controls.enablePan=!0,this.controls.enabled=!0,this.controls.target.set(0,0,0),this.css3dControls=new B(this.camera,this.css3DRenderer.domElement),this.css3dControls.enablePan=!1,this.css3dControls.enabled=!1,this.css3dControls.enableDamping=!1,this.css3dControls.target.set(0,0,0),this.css3dControls.update()}sceneAnimation(){this.renderAnimation=requestAnimationFrame(()=>this.sceneAnimation());const{stage:e,tags:i}=this.config;e&&e.glow?this.setMeshFlow():(this.effectComposer.render(),this.controls.update()),i&&i.dragTagList.length&&(this.css3DRenderer.render(this.scene,this.camera),this.css3dControls.update())}setMeshFlow(){this.scene.traverse(e=>{e instanceof F&&(this.materials.gridHelper=e.material,e.material=new w({color:"#000"})),e instanceof A&&(this.materials.scene=e.background,this.materials.environment=e.environment,e.background=null,e.environment=null),!this.glowMaterialList.includes(e.name)&&e.isMesh&&(this.materials[e.uuid]=e.material,e.material=new w({color:"#000"}))}),this.glowComposer.render(),this.scene.traverse(e=>{this.materials[e.uuid]&&(e.material=this.materials[e.uuid],delete this.materials[e.uuid]),e instanceof F&&(e.material=this.materials.gridHelper,delete this.materials.gridHelper),e instanceof A&&(e.background=this.materials.scene,e.environment=this.materials.environment,delete this.materials.scene,delete this.materials.environment)}),this.effectComposer.render(),this.controls.update()}createEffectComposer(){const{clientHeight:e,clientWidth:i}=this.container;this.effectComposer=new W(this.renderer);const t=new j(this.scene,this.camera);this.effectComposer.addPass(t),this.outlinePass=new de(new y(i,e),this.scene,this.camera),this.outlinePass.visibleEdgeColor=new p("#FF8C00"),this.outlinePass.hiddenEdgeColor=new p("#8a90f3"),this.outlinePass.edgeGlow=2,this.outlinePass.edgeThickness=1,this.outlinePass.edgeStrength=4,this.outlinePass.pulsePeriod=100,this.effectComposer.addPass(this.outlinePass);let s=new ce;this.effectComposer.addPass(s);let o=new O(me);const n=this.renderer.getPixelRatio();o.uniforms.resolution.value.set(1/(i*n),1/(e*n)),o.renderToScreen=!0,o.needsSwap=!0,this.effectComposer.addPass(o),this.unrealBloomPass=new pe(new y(i,e),0,0,0);const a={minFilter:C,magFilter:C,format:Be,stencilBuffer:!1},r=new ue(i*2,e*2,a);this.glowComposer=new W(this.renderer,r),this.glowComposer.renderToScreen=!1,this.glowComposer.addPass(new j(this.scene,this.camera)),this.glowComposer.addPass(this.unrealBloomPass),this.shaderPass=new O(new ge({uniforms:{baseTexture:{value:null},bloomTexture:{value:this.glowComposer.renderTarget2.texture},tDiffuse:{value:null},glowColor:{value:null}},vertexShader:fe,fragmentShader:we,defines:{}}),"baseTexture"),this.shaderPass.material.uniforms.glowColor.value=new p,this.shaderPass.renderToScreen=!0,this.shaderPass.needsSwap=!0,this.effectComposer.addPass(this.shaderPass)}loadModel({filePath:e,fileType:i,map:t}){return new Promise((s,o)=>{let n;if(["glb","gltf"].includes(i)){const a=new Le;a.setDecoderPath("draco/gltf/"),a.setDecoderConfig({type:"js"}),a.preload(),n=new S().setDRACOLoader(a)}else n=this.fileLoaderMap[i];n.load(e,a=>{switch(i){case"glb":this.model=a.scene;break;case"fbx":this.model=a;break;case"gltf":this.model=a.scene;break;case"obj":this.model=a;break;case"stl":const r=new w,h=new I(a,r);this.model=h;break}this.getModelMaterialList(t),this.modelAnimation=a.animations||[],this.setModelPositionSize(),this.glowMaterialList=this.modelMaterialList.map(r=>r.name),this.scene.add(this.model),s(!0)},()=>{},a=>{X.error("文件错误"),console.log(a),o()})})}onWindowResize(){const{clientHeight:e,clientWidth:i}=this.container;if(this.camera.aspect=i/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(i,e),this.css3DRenderer.setSize(i,e),this.effectComposer){var t=this.effectComposer.passes[3];const s=this.renderer.getPixelRatio();t.uniforms.resolution.value.set(1/(i*s),1/(e*s)),this.effectComposer.setSize(i,e)}this.glowComposer&&this.glowComposer.setSize(i,e)}onClearModelData(){cancelAnimationFrame(this.rotationAnimationFrame),cancelAnimationFrame(this.renderAnimation),cancelAnimationFrame(this.animationFrame),this.config,this.scene.traverse(e=>{e.type==="Mesh"&&(e.geometry.dispose(),e.material.dispose())}),this.scene.clear(),this.renderer.clear(),this.renderer.dispose(),this.camera.clear(),this.gridHelper&&(this.gridHelper.clear(),this.gridHelper.dispose()),this.axesHelper&&(this.axesHelper.clear(),this.axesHelper.dispose()),this.effectComposer&&this.effectComposer.dispose(),this.glowComposer&&this.glowComposer.dispose(),this.container.removeEventListener("mousemove",this.onMouseMoveListener),window.removeEventListener("resize",this.onWindowResizesListener),this.config=null,this.container=null,this.camera=null,this.scene=null,this.renderer=null,this.controls=null,this.model=null,this.fileLoaderMap=null,this.modelAnimation=null,this.animationMixer=null,this.animationClock=null,this.animationFrame=null,this.rotationAnimationFrame=null,this.animateClipAction=null,this.loopMap=null,this.gridHelper=null,this.axesHelper=null,this.planeGeometry=null,this.modelMaterialList=null,this.effectComposer=null,this.outlinePass=null,this.renderAnimation=null,this.raycaster==null,this.mouse=null,this.modelTextureMap=null,this.glowComposer=null,this.unrealBloomPass=null,this.shaderPass=null,this.glowMaterialList=null,this.materials=null,this.css3dControls=null,this.css3DRenderer=null}setModelPositionSize(){this.model.updateMatrixWorld();const e=new Ce().setFromObject(this.model),i=e.getSize(new G),t=e.getCenter(new G),s=Math.max(i.x,i.y,i.z),n=2.5/(s>1?s:.5);this.model.scale.set(n,n,n),this.model.position.sub(t.multiplyScalar(n)),this.controls.maxDistance=i.length()*10,this.camera.updateProjectionMatrix()}getModelMaterialList(){this.modelMaterialList=[],this.model.traverse(e=>{if(e.isMesh&&(e.castShadow=!0,e.frustumCulled=!1,e.material)){const i=e.material.clone();e.material=i,this.modelMaterialList.push(e)}})}setSceneBackground(){const{background:e}=this.config;if(!e)return!1;if(e.visible){const{color:i,image:t,viewImg:s,intensity:o,blurriness:n}=e;switch(e.type){case 1:this.scene.background=new p(i);break;case 2:const a=new L().load(t);this.scene.background=a,a.dispose();break;case 3:const r=new L().load(s);r.mapping=Me,this.scene.background=r,this.scene.environment=r,this.scene.backgroundIntensity=o,this.scene.backgroundBlurriness=n,r.dispose();break}}else this.scene.background=new p("#000")}setModelMeaterial(){const{material:e}=this.config;if(!e||!e.meshList)return!1;const i=N.map(t=>t.id);e.meshList.forEach(t=>{const s=this.model.getObjectByProperty("name",t.meshName),{color:o,opacity:n,depthWrite:a,wireframe:r,visible:h,type:d}=t,{map:m}=s.material;if(e.materialType?s.material=new z[d]({map:m}):s.material.map=m,t.meshFrom)if(i.includes(t.meshFrom)){const c=N.find(f=>f.id==t.meshFrom)||{},l=new L().load(c.url);l.wrapS=V,l.wrapT=V,l.flipY=!1,l.colorSpace=k,l.minFilter=C,l.magFilter=C,e.materialType?s.material=new z[d]({map:l}):s.material.map=l,l.dispose()}else{const c=this.model.getObjectByProperty("name",t.meshFrom),{map:l}=c.material;e.materialType?s.material=new z[d]({map:l}):s.material.map=l}s.material.visible=h,s.material.color.set(new p(o)),s.material.wireframe=r,s.material.depthWrite=a,s.material.transparent=!0,s.material.opacity=n})}setModelLaterStage(){const{stage:e}=this.config;if(!e)return!1;const{threshold:i,strength:t,radius:s,toneMappingExposure:o,meshPositonList:n,color:a}=e;e.glow?(this.unrealBloomPass.threshold=i,this.unrealBloomPass.strength=t,this.unrealBloomPass.radius=s,this.renderer.toneMappingExposure=o,this.shaderPass.material.uniforms.glowColor.value=new p(a)):(this.unrealBloomPass.threshold=0,this.unrealBloomPass.strength=0,this.unrealBloomPass.radius=0,this.renderer.toneMappingExposure=o,this.shaderPass.material.uniforms.glowColor.value=new p),n.forEach(r=>{const h=this.model.getObjectByProperty("name",r.name),{rotation:d,scale:m,position:c}=r;h.rotation.set(d.x,d.y,d.z),h.scale.set(m.x,m.y,m.z),h.position.set(c.x,c.y,c.z)})}setSceneLight(){const{light:e}=this.config;if(!e)return!1;if(e.ambientLight){const t=new be(e.ambientLightColor,e.ambientLightIntensity);t.visible=e.ambientLight,this.scene.add(t)}if(e.directionalLight){const t=new xe(e.directionalLightColor,e.directionalLightIntensity),{x:s,y:o,z:n}=H(e.directionalHorizontal,e.directionalVertical,e.directionalSistance);t.position.set(s,o,n),t.castShadow=e.directionaShadow,t.visible=e.directionalLight,this.scene.add(t);const a=new Pe(t,.5);a.visible=e.directionalLightHelper,this.scene.add(a)}if(e.pointLight){const t=new Se(e.pointLightColor,e.pointLightIntensity,100);t.visible=e.pointLight;const{x:s,y:o,z:n}=H(e.pointHorizontal,e.pointVertical,e.pointSistance);t.position.set(s,o,n),this.scene.add(t);const a=new ye(t,.5);a.visible=e.pointLightHelper,this.scene.add(a)}if(e.spotLight){const t=new Ae(e.spotLightColor,900);t.visible=e.spotLight;const s=new L().load(Fe("image/model-bg-1.jpg"));s.dispose(),t.map=s,t.decay=2,t.shadow.mapSize.width=1920,t.shadow.mapSize.height=1080,t.shadow.camera.near=1,t.shadow.camera.far=10,t.intensity=e.spotLightIntensity,t.angle=e.spotAngle,t.penumbra=e.spotPenumbra,t.shadow.focus=e.spotFocus,t.castShadow=e.spotCastShadow,t.distance=e.spotDistance;const{x:o,y:n,z:a}=H(e.spotHorizontal,e.spotVertical,e.spotSistance);t.position.set(o,n,a),this.scene.add(t);const r=new ze(t);r.visible=e.spotLightHelper&&e.spotLight,this.scene.add(r)}if(e.planeGeometry){const t=new He(e.planeWidth,e.planeHeight);var i=new w({color:e.planeColor});const s=new I(t,i);s.rotation.x=-Math.PI/2,s.position.set(0,-1.2,0),s.visible=e.planeGeometry,s.material.side=Re,s.geometry.verticesNeedUpdate=!0,s.receiveShadow=!0,this.scene.add(s)}}setModelAnimation(){const{animation:e}=this.config;if(!e)return!1;if(this.modelAnimation.length&&e&&e.visible){this.animationMixer=new ve(this.model);const{animationName:i,timeScale:t,weight:s,loop:o}=e,n=Ee.findByName(this.modelAnimation,i);n&&(this.animateClipAction=this.animationMixer.clipAction(n),this.animateClipAction.setEffectiveTimeScale(t),this.animateClipAction.setEffectiveWeight(s),this.animateClipAction.setLoop(this.loopMap[o]),this.animateClipAction.play()),this.animationFrameFun()}if(e.rotationVisible){const{rotationType:i,rotationSpeed:t}=e;this.rotationAnimationFun(i,t)}}animationFrameFun(){this.animationFrame=requestAnimationFrame(()=>this.animationFrameFun()),this.animationMixer&&this.animationMixer.update(this.animationClock.getDelta())}rotationAnimationFun(e,i){this.rotationAnimationFrame=requestAnimationFrame(()=>this.rotationAnimationFun(e,i)),this.model.rotation[e]+=i/50}setModelAxleLine(){const{attribute:e}=this.config;if(!e)return!1;const{axesHelper:i,axesSize:t,color:s,divisions:o,gridHelper:n,positionX:a,positionY:r,positionZ:h,size:d,visible:m,x:c,y:l,z:f,rotationX:M,rotationY:v,rotationZ:b}=e;if(!m)return!1;this.gridHelper=new F(d,o,s,s),this.gridHelper.position.set(c,l,f),this.gridHelper.visible=n,this.gridHelper.material.linewidth=.1,this.scene.add(this.gridHelper),this.axesHelper=new De(t),this.axesHelper.visible=i,this.axesHelper.position.set(0,-.5,0),this.scene.add(this.axesHelper),this.model.position.set(a,r,h),this.model.rotation.set(M,v,b),this.renderer.shadowMap.enabled=!0}setSceneTagsRender(){const{tags:e}=this.config;e&&e.dragTagList.length&&(this.container.appendChild(this.css3DRenderer.domElement),e.dragTagList.forEach(i=>{let t=document.createElement("div");const{backgroundColor:s,color:o,fontSize:n,height:a,iconColor:r,iconName:h,iconSize:d,innerText:m,positionX:c,positionY:l,positionZ:f,width:M}=i,b=Y({render(){let P;return u("div",null,[u("div",{className:"element-tag",style:{width:M+"px",height:a+"px",fontSize:n+"px",color:o,backgroundColor:s,boxShadow:`0px 0px 4px ${s}`}},[u("span",{className:"tag-txt"},[m])]),u("div",{className:"tag-icon"},[u($,null,We(P=R(J[h]))?P:{default:()=>[P]})])])}}).mount(document.createElement("div"));t.appendChild(b.$el);let x=new Te(t);x.position.set(c,l,f),x.scale.set(.01,.01,.01);const E=t.querySelector(".tag-icon");E.style.fontSize=d+"px",E.style.color=r,this.scene.add(x)}))}}function Ge(g){const e="answer"+Z(5,10);let i=null;return q({data(){return{loading:!1}},props:["width","height"],watch:{$props:{handler(t){i&&ke(i.onWindowResize(),200)},immediate:!1,deep:!0}},render(){return this.width&&this.height?R(D(u("div",{style:{width:this.width-10+"px",height:this.height-10+"px",pointerEvents:"none"},id:e},null),[[T("zLoading"),this.loading]])):R(D(u("div",{style:{width:"100%",height:"100%"},id:e},null),[[T("zLoading"),this.loading]]))},async mounted(){this.loading=!0,i=new je(g,e),await i.init()&&(this.loading=!1)},beforeUnmount(){i.onClearModelData()}})}export{Ge as c};

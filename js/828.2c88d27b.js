"use strict";(self["webpackChunkts_project"]=self["webpackChunkts_project"]||[]).push([[828],{2828:function(e,t,i){var s=i(7327),o=(i(560),i(6252)),n=i(9477),a=i(8558),r=i(7836),l=i(8606),h=i(4458),d=i(8939),c=i(1129),m=i(7531),p=i(185),u=i(6591),g=i(7011),w=i(1411),f=i(3623),M=i(9993),v=i(5294),L=i(1348);class b{constructor(e,t){(0,s.Z)(this,"config",void 0),(0,s.Z)(this,"container",void 0),(0,s.Z)(this,"camera",void 0),(0,s.Z)(this,"scene",void 0),(0,s.Z)(this,"renderer",void 0),(0,s.Z)(this,"controls",void 0),(0,s.Z)(this,"model",void 0),(0,s.Z)(this,"fileLoaderMap",void 0),(0,s.Z)(this,"modelAnimation",void 0),(0,s.Z)(this,"animationMixer",void 0),(0,s.Z)(this,"animationColock",void 0),(0,s.Z)(this,"animationFrame",void 0),(0,s.Z)(this,"rotationAnimationFrame",void 0),(0,s.Z)(this,"animateClipAction",void 0),(0,s.Z)(this,"loopMap",void 0),(0,s.Z)(this,"skeletonHelper",void 0),(0,s.Z)(this,"gridHelper",void 0),(0,s.Z)(this,"axesHelper",void 0),(0,s.Z)(this,"planeGeometry",void 0),(0,s.Z)(this,"modelMaterialList",void 0),(0,s.Z)(this,"effectComposer",void 0),(0,s.Z)(this,"outlinePass",void 0),(0,s.Z)(this,"renderAnimation",void 0),(0,s.Z)(this,"raycaster",void 0),(0,s.Z)(this,"mouse",void 0),(0,s.Z)(this,"modelTextureMap",void 0),(0,s.Z)(this,"glowComposer",void 0),(0,s.Z)(this,"unrealBloomPass",void 0),(0,s.Z)(this,"glowMaterialList",void 0),(0,s.Z)(this,"materials",void 0),(0,s.Z)(this,"onWindowResizesListener",void 0),(0,s.Z)(this,"onMouseMoveListener",void 0),this.config=e,this.container=document.querySelector("#"+t),this.camera,this.scene,this.renderer,this.controls,this.model,this.fileLoaderMap={glb:new r.E,fbx:new w.y,gltf:new r.E,obj:new g.L},this.modelAnimation,this.animationMixer,this.animationColock=new n.Clock,this.animationFrame,this.rotationAnimationFrame,this.animateClipAction=null,this.loopMap={LoopOnce:n.LoopOnce,LoopRepeat:n.LoopRepeat,LoopPingPong:n.LoopPingPong},this.skeletonHelper,this.gridHelper,this.axesHelper,this.planeGeometry,this.modelMaterialList,this.effectComposer,this.outlinePass,this.renderAnimation,this.raycaster=new n.Raycaster,this.mouse=new n.Vector2,this.modelTextureMap,this.glowComposer,this.unrealBloomPass,this.glowMaterialList,this.materials={},this.onWindowResizesListener,this.onMouseMoveListener}init(){return new Promise((async(e,t)=>{this.initRender(),this.initCamera(),this.initScene(),this.initControls();const i=await this.loadModel(this.config.fileInfo);this.createEffectComposer(),this.setSceneBackground(),this.setModelMeaterial(),this.setModelLaterStage(),this.setSceneLight(),this.setModelAnimation(),this.setModelAxleLine(),this.sceneAnimation(),this.addEvenListMouseLisatener(),e(i)}))}initRender(){this.renderer=new n.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(window.devicePixelRatio);const{clientHeight:e,clientWidth:t}=this.container;this.renderer.setSize(t,e),this.renderer.toneMapping=n.ReinhardToneMapping,this.renderer.autoClear=!0,this.renderer.toneMappingExposure=3,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=n.PCFSoftShadowMap;const i=document.createElement("div");i.id="mesh-txt",this.container.appendChild(i),this.container.appendChild(this.renderer.domElement)}initCamera(){const{clientHeight:e,clientWidth:t}=this.container;this.camera=new n.PerspectiveCamera(45,t/e,.25,1e3),this.camera.near=.1;const{camera:i}=this.config;if(!i)return!1;const{x:s,y:o,z:a}=i;this.camera.position.set(s,o,a),this.camera.updateProjectionMatrix()}initScene(){this.scene=new n.Scene}addEvenListMouseLisatener(){this.onWindowResizesListener=this.onWindowResize.bind(this),window.addEventListener("resize",this.onWindowResizesListener),this.onMouseMoveListener=this.onMouseMoveModel.bind(this),this.container.addEventListener("mousemove",this.onMouseMoveListener)}initControls(){this.controls=new a.z(this.camera,this.renderer.domElement),this.controls.enablePan=!0,this.controls.enabled=!0}sceneAnimation(){this.renderAnimation=requestAnimationFrame((()=>this.sceneAnimation())),this.controls.update(),this.scene.traverse((e=>{e instanceof n.Scene&&(this.materials.scene=e.background,e.background=null),!this.glowMaterialList.includes(e.name)&&e.isMesh&&(this.materials[e.uuid]=e.material,e.material=new n.MeshBasicMaterial({color:"black"}))})),this.glowComposer.render(),this.scene.traverse((e=>{this.materials[e.uuid]&&(e.material=this.materials[e.uuid],delete this.materials[e.uuid]),e instanceof n.Scene&&(e.background=this.materials.scene,delete this.materials.scene)})),this.effectComposer.render()}createEffectComposer(){const{clientHeight:e,clientWidth:t}=this.container;this.effectComposer=new l.x(this.renderer);const i=new h.C(this.scene,this.camera);this.effectComposer.addPass(i),this.outlinePass=new d.f(new n.Vector2(t,e),this.scene,this.camera),this.outlinePass.visibleEdgeColor=new n.Color("#FF8C00"),this.outlinePass.hiddenEdgeColor=new n.Color("#8a90f3"),this.outlinePass.edgeGlow=2,this.outlinePass.edgeThickness=1,this.outlinePass.edgeStrength=4,this.outlinePass.pulsePeriod=100,this.effectComposer.addPass(this.outlinePass);let s=new c.v;this.effectComposer.addPass(s);let o=new m.T(p.C);const a=this.renderer.getPixelRatio();o.uniforms.resolution.value.set(1/(t*a),1/(e*a)),o.renderToScreen=!0,o.needsSwap=!0,this.effectComposer.addPass(o),this.unrealBloomPass=new u.m(new n.Vector2(t,e),0,0,0);const r={minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBAFormat,stencilBuffer:!1},g=new n.WebGLRenderTarget(2*t,2*e,r);this.glowComposer=new l.x(this.renderer,g),this.glowComposer.renderToScreen=!1,this.glowComposer.addPass(new h.C(this.scene,this.camera)),this.glowComposer.addPass(this.unrealBloomPass);let w=new m.T(new n.ShaderMaterial({uniforms:{baseTexture:{value:null},bloomTexture:{value:this.glowComposer.renderTarget2.texture},tDiffuse:{value:null}},vertexShader:f.C7,fragmentShader:f.zH,defines:{}}),"baseTexture");w.renderToScreen=!0,w.needsSwap=!0,this.effectComposer.addPass(w)}loadModel(e){const{filePath:t,fileType:i,scale:s,map:o,position:a}=e;return new Promise(((e,r)=>{const l=this.fileLoaderMap[i];l.load(t,(t=>{switch(i){case"glb":this.model=t.scene,this.skeletonHelper=new n.SkeletonHelper(t.scene);break;case"fbx":this.model=t,this.skeletonHelper=new n.SkeletonHelper(t);break;case"gltf":this.model=t.scene,this.skeletonHelper=new n.SkeletonHelper(t.scene);break;case"obj":this.model=t,this.skeletonHelper=new n.SkeletonHelper(t);break;default:break}if(this.getModelMeaterialList(o),this.modelAnimation=t.animations||[],this.setModelPositionSize(),s&&this.model.scale.set(s,s,s),this.model.position.set(0,-.5,0),a){const{x:e,y:t,z:i}=a;this.model.position.set(e,t,i)}this.skeletonHelper.visible=!1,this.scene.add(this.skeletonHelper),this.glowMaterialList=this.modelMaterialList.map((e=>e.name)),this.scene.add(this.model),e(!0)}),(()=>{}),(e=>{L.z8.error("文件错误"),console.log(e),r()}))}))}onWindowResize(){const{clientHeight:e,clientWidth:t}=this.container;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.effectComposer&&this.effectComposer.setSize(t,e),this.glowComposer&&this.glowComposer.setSize(t,e)}onClearModelData(){cancelAnimationFrame(this.rotationAnimationFrame),cancelAnimationFrame(this.renderAnimation),cancelAnimationFrame(this.animationFrame),this.scene.traverse((e=>{"Mesh"===e.type&&(e.geometry.dispose(),e.material.dispose())})),this.scene.clear(),this.renderer.clear(),this.renderer.dispose(),this.camera.clear(),this.gridHelper&&(this.gridHelper.clear(),this.gridHelper.dispose()),this.axesHelper&&(this.axesHelper.clear(),this.axesHelper.dispose()),this.effectComposer.dispose(),this.glowComposer.dispose(),this.container.removeEventListener("mousemove",this.onMouseMoveListener),window.removeEventListener("resize",this.onWindowResizesListener),this.config=null,this.container=null,this.camera=null,this.scene=null,this.renderer=null,this.controls=null,this.model=null,this.fileLoaderMap={},this.modelAnimation=null,this.animationMixer=null,this.animationColock=null,this.animationFrame=null,this.rotationAnimationFrame=null,this.animateClipAction=null,this.loopMap={},this.skeletonHelper=null,this.gridHelper=null,this.axesHelper=null,this.planeGeometry=null,this.modelMaterialList=null,this.effectComposer=null,this.outlinePass=null,this.renderAnimation=null,this.raycaster,this.mouse=null,this.modelTextureMap=null,this.glowComposer=null,this.unrealBloomPass=null,this.glowMaterialList=null,this.materials={}}setModelPositionSize(){this.model.updateMatrixWorld();const e=(new n.Box3).setFromObject(this.model),t=e.getSize(new n.Vector3),i=e.getCenter(new n.Vector3),s=Math.max(t.x,t.y,t.z),o=2.5,a=o/(s>1?s:.5);this.model.scale.set(a,a,a),this.controls.maxDistance=10*t.length(),this.camera.lookAt(i),this.camera.updateProjectionMatrix()}getModelMeaterialList(e){const t=!!e;this.modelMaterialList=[],this.model.traverse((i=>{if(i.isMesh){if(i.castShadow=!0,i.frustumCulled=!1,i.material){const{name:e,color:t,map:s}=i.material,o=i.material.clone();i.material=o,this.modelMaterialList.push(i)}if(i.material&&t){const t=(new n.TextureLoader).load(e),s=i.material.clone();i.material=s,i.material.map=t}}}))}setSceneBackground(){const{background:e}=this.config;if(!e)return!1;const{color:t,image:i,viewImg:s}=e;if(e.visible)switch(e.type){case 1:this.scene.background=new n.Color(t);break;case 2:this.scene.background=(new n.TextureLoader).load(i);break;case 3:const e=(new n.TextureLoader).load(s);e.mapping=n.EquirectangularReflectionMapping,this.scene.background=e,this.scene.environment=e;break;default:break}else this.scene.background=new n.Color("#000")}setModelMeaterial(){const{material:e}=this.config;if(!e||!e.meshList)return!1;const t=M.or.map((e=>e.id));e.meshList.forEach((i=>{const s=this.model.getObjectByProperty("name",i.meshName),{color:o,opacity:a,depthWrite:r,wireframe:l,visible:h,type:d}=i,{map:c}=s.material;if(e.materialType?s.material=new n[d]({map:c}):s.material.map=c,i.meshFrom)if(t.includes(i.meshFrom)){const t=M.or.find((e=>e.id==i.meshFrom))||{},o=(new n.TextureLoader).load(t.url);e.materialType?s.material=new n[d]({map:o}):s.material.map=o}else{const t=this.model.getObjectByProperty("name",i.meshFrom),{map:o}=t.material;e.materialType?s.material=new n[d]({map:o}):s.material.map=o}s.material.visible=h,s.material.color.set(new n.Color(o)),s.material.wireframe=l,s.material.depthWrite=r,s.material.transparent=!0,s.material.opacity=a}))}setModelLaterStage(){const{stage:e}=this.config;if(!e)return!1;const{threshold:t,strength:i,radius:s,toneMappingExposure:o,meshPositonList:n}=e;e.glow?(this.unrealBloomPass.threshold=t,this.unrealBloomPass.strength=i,this.unrealBloomPass.radius=s,this.renderer.toneMappingExposure=o):(this.unrealBloomPass.threshold=0,this.unrealBloomPass.strength=0,this.unrealBloomPass.radius=0,this.renderer.toneMappingExposure=o),n.forEach((e=>{const t=this.model.getObjectByProperty("name",e.name),{x:i,y:s,z:o}=e;t.position.set(i,s,o)}))}onMouseMoveModel(e){if(this.modelAnimation.length)return!1;const{clientHeight:t,clientWidth:i,offsetLeft:s,offsetTop:o}=this.container;if(!this.mouse)return!1;this.mouse.x=(e.clientX-s)/i*2-1,this.mouse.y=-(e.clientY-o)/t*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const n=this.raycaster.intersectObjects(this.scene.children).filter((e=>e.object.isMesh&&this.glowMaterialList.includes(e.object.name)));if(n.length>0){const t=document.getElementById("mesh-txt");if(this.modelAnimation.length)return document.body.style.cursor="pointer",!1;const{hoverMeshTag:i}=this.config.stage;if(i){const i=n[0].object;t.innerHTML=i.name,t.style.display="block",t.style.top=e.clientY-o+"px",t.style.left=e.clientX-s+20+"px"}document.body.style.cursor="pointer"}else{const e=document.getElementById("mesh-txt");document.body.style.cursor="",e.style.display="none"}}setSceneLight(){const{light:e}=this.config;if(!e)return!1;if(e.ambientLight){const t=new n.AmbientLight(e.ambientLightColor,e.ambientLightIntensity);t.visible=e.ambientLight,this.scene.add(t)}if(e.directionalLight){const t=new n.DirectionalLight(e.directionalLightColor,e.directionalLightIntensity),{x:i,y:s,z:o}=(0,v.E3)(e.directionalHorizontal,e.directionalVertical,e.directionalSistance);t.position.set(i,s,o),t.castShadow=e.directionaShadow,t.visible=e.directionalLight,this.scene.add(t);const a=new n.DirectionalLightHelper(t,.5);a.visible=e.directionalLightHelper,this.scene.add(a)}if(e.pointLight){const t=new n.PointLight(e.pointLightColor,e.pointLightIntensity,100);t.visible=e.pointLight;const{x:i,y:s,z:o}=(0,v.E3)(e.pointHorizontal,e.pointVertical,e.pointSistance);t.position.set(i,s,o),this.scene.add(t);const a=new n.PointLightHelper(t,.5);a.visible=e.pointLightHelper,this.scene.add(a)}if(e.spotLight){const t=new n.SpotLight(e.spotLightColor,900);t.visible=e.spotLight,t.map=(new n.TextureLoader).load(i(8208)),t.decay=2,t.shadow.mapSize.width=1920,t.shadow.mapSize.height=1080,t.shadow.camera.near=1,t.shadow.camera.far=10,t.intensity=e.spotLightIntensity,t.angle=e.spotAngle,t.penumbra=e.spotPenumbra,t.shadow.focus=e.spotFocus,t.castShadow=e.spotCastShadow,t.distance=e.spotDistance;const{x:s,y:o,z:a}=(0,v.E3)(e.spotHorizontal,e.spotVertical,e.spotSistance);t.position.set(s,o,a),this.scene.add(t);const r=new n.SpotLightHelper(t);r.visible=e.spotLightHelper&&e.spotLight,this.scene.add(r)}if(e.planeGeometry){const i=new n.PlaneGeometry(e.planeWidth,e.planeHeight);var t=new n.MeshStandardMaterial({color:e.planeColor});const s=new n.Mesh(i,t);s.name="planeGeometry",s.rotation.x=-Math.PI/2,s.position.set(0,-.5,0),s.visible=e.planeGeometry,s.geometry.verticesNeedUpdate=!0,s.receiveShadow=!0,this.scene.add(s)}}setModelAnimation(){const{animation:e}=this.config;if(!e)return!1;if(this.modelAnimation.length&&e&&e.visible){this.animationMixer=new n.AnimationMixer(this.model);const{animationName:t,timeScale:i,weight:s,loop:o}=e,a=n.AnimationClip.findByName(this.modelAnimation,t);a&&(this.animateClipAction=this.animationMixer.clipAction(a),this.animateClipAction.setEffectiveTimeScale(i),this.animateClipAction.setEffectiveWeight(s),this.animateClipAction.setLoop(this.loopMap[o]),this.animateClipAction.play()),this.animationFrameFun()}if(e.rotationVisible){const{rotationType:t,rotationSpeed:i}=e;this.rotationAnimationFun(t,i)}}animationFrameFun(){this.animationFrame=requestAnimationFrame((()=>this.animationFrameFun())),this.animationMixer&&this.animationColock&&this.animationMixer.update(this.animationColock.getDelta())}rotationAnimationFun(e,t){this.rotationAnimationFrame=requestAnimationFrame((()=>this.rotationAnimationFun(e,t))),this.model.rotation[e]+=t/50}setModelAxleLine(){const{attribute:e}=this.config;if(!e)return!1;const{axesHelper:t,axesSize:i,color:s,divisions:o,gridHelper:a,positionX:r,positionY:l,positionZ:h,size:d,skeletonHelper:c,visible:m,x:p,y:u,z:g,rotationX:w,rotationY:f,rotationZ:M}=e;if(!m)return!1;this.gridHelper=new n.GridHelper(d,o,s,s),this.gridHelper.position.set(p,u,g),this.gridHelper.visible=a,this.gridHelper.material.linewidth=.1,this.scene.add(this.gridHelper),this.axesHelper=new n.AxesHelper(i),this.axesHelper.visible=t,this.axesHelper.position.set(0,-.5,0),this.scene.add(this.axesHelper),this.skeletonHelper.visible=c,this.model.position.set(r,l,h),this.model.rotation.set(w,f,M),this.renderer.shadowMap.enabled=!0}}function C(e){const t="answer"+(0,v.d1)(5,10);let i=null;return(0,o.aZ)({data(){return{loading:!1}},props:{width:{type:Number,required:!1},height:{type:Number,required:!1}},watch:{$props:{handler(){i&&(0,v.Ds)(i.onWindowResize(),200)},immediate:!1,deep:!0}},render(){const e=(0,o.Q2)("zLoading");return this.width&&this.height?(0,o.wy)((0,o.h)("div",{style:{width:this.width-10+"px",height:this.height-10+"px",pointerEvents:"none"},id:t}),[[e,this.loading]]):(0,o.wy)((0,o.h)("div",{style:{width:"100%",height:"100%"},id:t}),[[e,this.loading]])},async mounted(){this.loading=!0,i=new b(e,t);const s=await i.init();s&&(this.loading=!1)},beforeUnmount(){i.onClearModelData()}})}t.Z=C}}]);
//# sourceMappingURL=828.2c88d27b.js.map